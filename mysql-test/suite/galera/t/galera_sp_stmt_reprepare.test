--source include/galera_cluster.inc


CREATE TABLE t1 (id INT PRIMARY KEY, TEXT VARCHAR(255));
CREATE TABLE t2 (id INT PRIMARY KEY, TEXT VARCHAR(255));

INSERT INTO t1 VALUES (1, 'test1');
INSERT INTO t1 VALUES (2, 'test2');
INSERT INTO t2 VALUES (1, 'test1');
INSERT INTO t2 VALUES (2, 'test2');

DELIMITER //;
CREATE PROCEDURE test_deadlock(IN TEXT VARCHAR(255))
BEGIN
DROP TABLE IF EXISTS t1_temp;
CREATE TEMPORARY TABLE t1_temp (id INT PRIMARY KEY) AS (SELECT id FROM t1 WHERE t1.text = text);
DELETE t2 FROM t2 INNER JOIN t1_temp ON t2.id=t1_temp.id;
END//

DELIMITER ;//

CALL test_deadlock('test1'); 
CALL test_deadlock('test2'); 

DROP TABLE t1;
DROP TABLE t2;
DROP PROCEDURE test_deadlock;
